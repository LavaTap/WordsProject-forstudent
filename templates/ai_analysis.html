{% extends "base.html" %}

{% block title %}
AI 数据分析报告
{% endblock %}

{% block page_css %}
<style>
    #mainTextArea {
        width: 100%;
        max-width: 800px;
        height: 200px;
        font-size: 1.125rem;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: vertical;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2 class="title text-xl font-bold mb-4">学习数据分析报告</h2>

    <!-- 报告展示 -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <pre class="whitespace-pre-wrap text-sm">{{ report }}</pre>
    </div>

    <!-- 聊天窗口展示 -->
    <div id="chat-window" class="mt-6 space-y-2"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatWindow = document.getElementById("chat-window");
    const inputArea = document.getElementById("mainTextArea");
    let history = [];

    function appendMessage(role) {
        const div = document.createElement("div");
        div.className = role === "user" ? "mt-2 text-right" : "mt-2 text-left";
        div.innerHTML = `
      <span class="badge ${role === 'user' ? 'bg-primary' : 'bg-secondary'}">
        ${role}
      </span>
      <span class="message-content"></span>
    `;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return div.querySelector(".message-content");
    }

    document.getElementById("send-btn").onclick = async () => {
        const text = inputArea.value.trim();
        if (!text) return;
        inputArea.value = "";

        // 展示用户消息
        appendMessage("user").textContent = text;
        history.push({ role: "user", content: text });

        // 添加助手占位
        const assistantEl = appendMessage("assistant");

        // 调用流式接口
        const resp = await fetch("{{ url_for('ai.ai_chat_stream') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history })
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let done = false;

        while (!done) {
            const { value, done: readerDone } = await reader.read();
            done = readerDone;
            if (value) {
                assistantEl.textContent += decoder.decode(value);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        history.push({
            role: "assistant",
            content: assistantEl.textContent
        });
    };
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}AI 智能对话{% endblock %}
{% block content %}
<div class="card">
    <h2 class="title">AI 智能对话</h2>
    <div id="chat-window" class="mt-4" style="max-height:400px; overflow-y:auto;"></div>
    <div class="form-row mt-4">
        <input type="text" id="user-input" class="input" placeholder="输入消息…" />
        <button id="send-btn" class="btn btn-primary">发送</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const chatWindow = document.getElementById("chat-window");
    let history = [];

    function appendMessage(role, initialText = "") {
        const div = document.createElement("div");
        div.className = role === "user"
            ? "mt-2 text-right"
            : "mt-2 text-left";
        // 用户直接 innerHTML；助手先插空
        div.innerHTML = `<span class="badge ${role === 'user' ? 'bg-primary' : 'bg-secondary'
            }">${role}</span> <span class="message-content"></span>`;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return div.querySelector(".message-content");
    }

    document.getElementById("send-btn").onclick = async () => {
        const input = document.getElementById("user-input");
        const text = input.value.trim();
        if (!text) return;
        input.value = "";

        // 先展现用户消息
        appendMessage("user", text).textContent = text;
        history.push({ role: "user", content: text });

        // 添加助手空占位，等待流式填充
        const assistantContentEl = appendMessage("assistant");

        // 调用流式端点
        const resp = await fetch("{{ url_for('ai.ai_chat_stream') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history })
        });

        // 逐段读取
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let done = false;

        while (!done) {
            const { value, done: readerDone } = await reader.read();
            done = readerDone;
            if (value) {
                // 追加新内容
                assistantContentEl.textContent += decoder.decode(value);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        // 将本次 assistant 回复加入 history
        history.push({
            role: "assistant",
            content: assistantContentEl.textContent
        });
    };
</script>

{% endblock %}